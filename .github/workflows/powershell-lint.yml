---
name: PowerShell Linting

on:
  workflow_dispatch:

jobs:
  powershell-lint:
    name: Lint PowerShell Scripts
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Install PSScriptAnalyzer
        shell: pwsh
        run: |
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser

      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          $results = @()
          Get-ChildItem -Path powershell -Filter *.ps1 -Recurse | ForEach-Object {
            Write-Host "Analyzing $($_.FullName)..."
            $analysis = Invoke-ScriptAnalyzer -Path $_.FullName -Settings PSScriptAnalyzerSettings.psd1
            if ($analysis) {
              $results += $analysis
              $analysis | Format-Table -AutoSize
            }
          }

          if ($results.Count -gt 0) {
            Write-Host "Found $($results.Count) issues"
            exit 1
          } else {
            Write-Host "No issues found"
          }

      - name: Check PowerShell syntax
        shell: pwsh
        run: |
          $hasErrors = $false
          Get-ChildItem -Path powershell -Filter *.ps1 -Recurse | ForEach-Object {
            Write-Host "Checking syntax: $($_.FullName)"
            $errors = $null
            $null = [System.Management.Automation.PSParser]::Tokenize(
              (Get-Content $_.FullName -Raw), [ref]$errors
            )
            if ($errors.Count -gt 0) {
              $hasErrors = $true
              $errors | ForEach-Object {
                Write-Error "$($_.Message) at line $($_.Token.StartLine)"
              }
            }
          }

          if ($hasErrors) {
            exit 1
          }
