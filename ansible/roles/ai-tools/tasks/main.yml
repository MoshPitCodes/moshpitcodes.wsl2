---
# AI Tools installation tasks

# ============================================
# Gemini CLI Installation
# ============================================

- name: Check if Gemini CLI is installed
  command: gemini --version
  register: gemini_installed
  ignore_errors: true
  changed_when: false
  become: true
  become_user: '{{ target_user }}'
  when: install_gemini_cli | default(true)
  tags: gemini

- name: Install/Update Gemini CLI
  community.general.npm:
      name: '{{ gemini_cli_package }}'
      version: '{{ gemini_cli_version }}'
      global: true
      state: "{{ 'latest' if gemini_cli_version == 'latest' else 'present' }}"
  when:
      - install_gemini_cli | default(true)
      - gemini_installed is failed
  tags: gemini

- name: Verify Gemini CLI installation
  command: gemini --version
  register: gemini_version
  changed_when: false
  become: true
  become_user: '{{ target_user }}'
  when: install_gemini_cli | default(true)
  tags: gemini

- name: Display Gemini CLI version
  ansible.builtin.debug:
      msg: 'Gemini CLI installed: {{ gemini_version.stdout_lines[0] }}'
  when:
      - install_gemini_cli | default(true)
      - gemini_version is defined
      - gemini_version.stdout_lines | length > 0
  tags: gemini

- name: Add Gemini CLI information to .bashrc
  ansible.builtin.blockinfile:
      path: '/home/{{ target_user }}/.bashrc'
      marker: '# {mark} ANSIBLE MANAGED GEMINI CLI'
      block: |
          # Gemini CLI - Google AI in your terminal
          # Run 'gemini' to start the interactive CLI
          # Authentication options:
          #   1. Interactive: Just run 'gemini' and login with Google
          #   2. API Key: export GEMINI_API_KEY="your_key"
          #   3. Vertex AI: export GOOGLE_API_KEY="your_key" and GOOGLE_GENAI_USE_VERTEXAI=true
      create: true
      owner: '{{ target_user }}'
      group: '{{ target_user }}'
      mode: '0644'
  when: install_gemini_cli | default(true)
  tags: gemini

# ============================================
# Claude Code Installation
# ============================================

- name: Check if Claude Code is installed
  command: claude --version
  register: claude_installed
  ignore_errors: true
  changed_when: false
  become: true
  become_user: '{{ target_user }}'
  when: install_claude_code | default(true)
  tags: claude

- name: Install/Update Claude Code
  community.general.npm:
      name: '{{ claude_code_package }}'
      global: true
      state: latest
  when:
      - install_claude_code | default(true)
      - claude_installed is failed
  tags: claude

- name: Verify Claude Code installation
  command: claude --version
  register: claude_version
  changed_when: false
  become: true
  become_user: '{{ target_user }}'
  when: install_claude_code | default(true)
  tags: claude

- name: Display Claude Code version
  ansible.builtin.debug:
      msg: 'Claude Code installed: {{ claude_version.stdout_lines[0] }}'
  when:
      - install_claude_code | default(true)
      - claude_version is defined
      - claude_version.stdout_lines | length > 0
  tags: claude

- name: Add Claude Code information to .bashrc
  ansible.builtin.blockinfile:
      path: '/home/{{ target_user }}/.bashrc'
      marker: '# {mark} ANSIBLE MANAGED CLAUDE CODE'
      block: |
          # Claude Code - Anthropic's AI coding assistant
          # Run 'claude' to start the interactive CLI
          # Documentation: https://code.claude.com/docs
      create: true
      owner: '{{ target_user }}'
      group: '{{ target_user }}'
      mode: '0644'
  when: install_claude_code | default(true)
  tags: claude

# ============================================
# Opencode Installation
# ============================================

- name: Check if Opencode is installed
  command: opencode --version
  register: opencode_installed
  ignore_errors: true
  changed_when: false
  become: true
  become_user: '{{ target_user }}'
  when: install_opencode | default(true)
  tags: opencode

# Method 1: Install Opencode via npm
- name: Install/Update Opencode via npm
  community.general.npm:
      name: '{{ opencode_package }}'
      version: '{{ opencode_version }}'
      global: true
      state: "{{ 'latest' if opencode_version == 'latest' else 'present' }}"
  when:
      - install_opencode | default(true)
      - opencode_install_method == "npm"
      - opencode_installed is failed
  tags: opencode

# Method 2: Install Opencode via curl script
- name: Install/Update Opencode via install script
  when:
      - install_opencode | default(true)
      - opencode_install_method == "script"
      - opencode_installed is failed
  tags: opencode
  block:
      - name: Download and execute Opencode install script
        shell: |
            curl -fsSL {{ opencode_install_script }} | bash
        become: true
        become_user: '{{ target_user }}'
        args:
            creates: '/home/{{ target_user }}/.opencode/bin/opencode'

- name: Check if Opencode is now installed (in user home)
  ansible.builtin.stat:
      path: '/home/{{ target_user }}/.opencode/bin/opencode'
  register: opencode_final_check
  when: install_opencode | default(true)
  tags: opencode

- name: Verify Opencode installation (script method)
  command: '/home/{{ target_user }}/.opencode/bin/opencode --version'
  register: opencode_version_output
  changed_when: false
  ignore_errors: true
  become: true
  become_user: '{{ target_user }}'
  when:
      - install_opencode | default(true)
      - opencode_install_method == "script"
      - opencode_final_check.stat.exists | default(false)
  tags: opencode

- name: Verify Opencode installation (npm method)
  command: opencode --version
  register: opencode_version_output_npm
  changed_when: false
  become: true
  become_user: '{{ target_user }}'
  ignore_errors: true
  when:
      - install_opencode | default(true)
      - opencode_install_method == "npm"
  tags: opencode

- name: Display Opencode version (script method)
  ansible.builtin.debug:
      msg: 'Opencode installed: {{ opencode_version_output.stdout_lines[0] }}'
  when:
      - install_opencode | default(true)
      - opencode_install_method == "script"
      - opencode_version_output is defined
      - opencode_version_output.stdout_lines is defined
      - opencode_version_output.stdout_lines | length > 0
  tags: opencode

- name: Display Opencode version (npm method)
  ansible.builtin.debug:
      msg: 'Opencode installed: {{ opencode_version_output_npm.stdout_lines[0] }}'
  when:
      - install_opencode | default(true)
      - opencode_install_method == "npm"
      - opencode_version_output_npm is defined
      - opencode_version_output_npm.stdout_lines is defined
      - opencode_version_output_npm.stdout_lines | length > 0
  tags: opencode

- name: Display Opencode installation note
  ansible.builtin.debug:
      msg: 'Opencode installed at /home/{{ target_user }}/.opencode/bin/opencode. PATH updated in .bashrc automatically.'
  when:
      - install_opencode | default(true)
      - opencode_install_method == "script"
      - opencode_final_check.stat.exists | default(false)
  tags: opencode

- name: Add Opencode information to .bashrc
  ansible.builtin.blockinfile:
      path: '/home/{{ target_user }}/.bashrc'
      marker: '# {mark} ANSIBLE MANAGED OPENCODE INFO'
      block: |
          # Opencode - AI-powered coding assistant
          # The install script has already added ~/.opencode/bin to PATH
          # Run 'opencode' to start the CLI
          # Documentation: https://opencode.ai/docs
      create: true
      owner: '{{ target_user }}'
      group: '{{ target_user }}'
      mode: '0644'
  when:
      - install_opencode | default(true)
      - opencode_install_method == "script"
  tags: opencode
