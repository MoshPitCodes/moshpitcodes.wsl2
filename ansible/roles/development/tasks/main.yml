---
# Development role - tasks
# Sets up development tools and programming language environments

- name: Install development packages
  ansible.builtin.apt:
    name: "{{ development_packages }}"
    state: present
  tags: packages

- name: Install Python packages
  ansible.builtin.apt:
    name: "{{ python_packages }}"
    state: present
  when: install_python | default(true)
  tags: python

- name: Install Python pip packages (user space)
  ansible.builtin.pip:
    name: "{{ pip_packages }}"
    state: present
    executable: pip3
    extra_args: "--user --break-system-packages"
  become: true
  become_user: "{{ target_user }}"
  when:
    - install_python | default(true)
    - pip_packages is defined
    - pip_packages | length > 0
  tags: python

- name: Extract Node.js major version
  ansible.builtin.set_fact:
    nodejs_major_version: "{{ nodejs_version.split('.')[0] }}"
  when: install_nodejs | default(false)
  tags: nodejs

- name: Download NodeSource setup script
  ansible.builtin.get_url:
    url: "https://deb.nodesource.com/setup_{{ nodejs_major_version }}.x"
    dest: /tmp/nodesource_setup.sh
    mode: '0755'
  when: install_nodejs | default(false)
  tags: nodejs

- name: Run NodeSource setup script
  command: /tmp/nodesource_setup.sh
  args:
    creates: /etc/apt/sources.list.d/nodesource.list
  when: install_nodejs | default(false)
  tags: nodejs

- name: Install Node.js
  ansible.builtin.apt:
    name: nodejs
    state: present
    update_cache: true
  when: install_nodejs | default(false)
  tags: nodejs

- name: Install npm global packages
  community.general.npm:
    name: "{{ item }}"
    global: true
    state: present
  loop: "{{ npm_global_packages }}"
  when:
    - install_nodejs | default(false)
    - npm_global_packages is defined
    - npm_global_packages | length > 0
  tags: nodejs

- name: Check if Go is installed
  ansible.builtin.stat:
    path: /usr/local/go/bin/go
  register: go_installed
  when: install_golang | default(false)
  tags: golang

- name: Download Go
  ansible.builtin.get_url:
    url: "https://go.dev/dl/go{{ golang_version }}.linux-amd64.tar.gz"
    dest: "/tmp/go{{ golang_version }}.linux-amd64.tar.gz"
    mode: '0644'
  when:
    - install_golang | default(false)
    - not go_installed.stat.exists
  tags: golang

- name: Remove old Go installation
  ansible.builtin.file:
    path: /usr/local/go
    state: absent
  when:
    - install_golang | default(false)
    - not go_installed.stat.exists
  tags: golang

- name: Extract Go archive
  ansible.builtin.unarchive:
    src: "/tmp/go{{ golang_version }}.linux-amd64.tar.gz"
    dest: /usr/local
    remote_src: true
  when:
    - install_golang | default(false)
    - not go_installed.stat.exists
  tags: golang

- name: Add Go to PATH
  ansible.builtin.blockinfile:
    path: "/home/{{ target_user }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED GO PATH"
    block: |
      # Go programming language
      export PATH=$PATH:/usr/local/go/bin
      export GOPATH=$HOME/go
      export PATH=$PATH:$GOPATH/bin
    create: true
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: '0644'
  when: install_golang | default(false)
  tags: golang

- name: Install Rust via rustup
  shell: |
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
  args:
    creates: "/home/{{ target_user }}/.cargo/bin/rustc"
  become: true
  become_user: "{{ target_user }}"
  when: install_rust | default(false)
  tags: rust

- name: Add Rust to PATH
  ansible.builtin.blockinfile:
    path: "/home/{{ target_user }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED RUST PATH"
    block: |
      # Rust programming language
      . "$HOME/.cargo/env"
    create: true
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: '0644'
  when: install_rust | default(false)
  tags: rust

- name: Install Ruby and development headers
  ansible.builtin.apt:
    name:
      - ruby-full
      - ruby-dev
    state: present
  when: install_ruby | default(false)
  tags: ruby

- name: Configure gem installation directory for user
  ansible.builtin.blockinfile:
    path: "/home/{{ target_user }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED RUBY GEMS PATH"
    block: |
      # Ruby gems
      export GEM_HOME="$HOME/.gem"
      export PATH="$HOME/.gem/bin:$PATH"
    create: true
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: '0644'
  when: install_ruby | default(false)
  tags: ruby

# ============================================================================
# Doppler CLI Installation
# ============================================================================

- name: Check if Doppler is installed
  command: doppler --version
  register: doppler_installed
  ignore_errors: true
  changed_when: false
  when: install_doppler | default(false)
  tags: doppler

- name: Install Doppler CLI
  when:
    - install_doppler | default(false)
    - doppler_installed is failed
  tags: doppler
  block:
    - name: Install prerequisites for Doppler
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
        state: present

    - name: Add Doppler GPG key
      apt_key:
        url: https://packages.doppler.com/public/cli/gpg.DE2A7741A397C129.key
        keyring: /usr/share/keyrings/doppler-archive-keyring.gpg
        state: present

    - name: Add Doppler repository
      apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/doppler-archive-keyring.gpg] https://packages.doppler.com/public/cli/deb/debian any-version main"
        filename: doppler-cli
        state: present

    - name: Update apt cache
      apt:
        update_cache: true

    - name: Install Doppler CLI
      apt:
        name: doppler
        state: present

- name: Verify Doppler installation
  command: doppler --version
  register: doppler_version_output
  changed_when: false
  when: install_doppler | default(false)
  tags: doppler

- name: Display Doppler version
  ansible.builtin.debug:
    msg: "Doppler CLI installed: {{ doppler_version_output.stdout }}"
  when:
    - install_doppler | default(false)
    - doppler_version_output is defined
  tags: doppler

# ============================================================================
# Nix Package Manager Installation
# ============================================================================

- name: Check if Nix is installed
  ansible.builtin.stat:
    path: /nix/var/nix/profiles/default/bin/nix
  register: nix_installed
  when: install_nix | default(false)
  tags: nix

- name: Install Nix package manager
  when:
    - install_nix | default(false)
    - not nix_installed.stat.exists
  tags: nix
  block:
    - name: Download Nix installer
      ansible.builtin.get_url:
        url: https://nixos.org/nix/install
        dest: /tmp/nix-install.sh
        mode: '0755'

    - name: Run Nix installer (multi-user mode)
      ansible.builtin.shell: |
        sh /tmp/nix-install.sh --daemon --yes
      args:
        creates: /nix/var/nix/profiles/default/bin/nix
      environment:
        NIX_INSTALLER_NO_MODIFY_PROFILE: "1"

    - name: Remove Nix installer script
      ansible.builtin.file:
        path: /tmp/nix-install.sh
        state: absent

- name: Configure Nix for user
  ansible.builtin.blockinfile:
    path: "/home/{{ target_user }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED NIX PATH"
    block: |
      # Nix package manager
      if [ -e /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
        . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
      fi
    create: true
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: '0644'
  when: install_nix | default(false)
  tags: nix

- name: Enable nix-daemon service
  ansible.builtin.systemd:
    name: nix-daemon
    enabled: true
    state: started
  when:
    - install_nix | default(false)
    - not nix_installed.stat.exists
  ignore_errors: true
  tags: nix

- name: Create Nix configuration directory
  ansible.builtin.file:
    path: /etc/nix
    state: directory
    mode: '0755'
  when: install_nix | default(false)
  tags: nix

- name: Configure Nix experimental features
  ansible.builtin.lineinfile:
    path: /etc/nix/nix.conf
    line: "experimental-features = nix-command flakes"
    create: true
    mode: '0644'
  when: install_nix | default(false)
  tags: nix

- name: Restart nix-daemon to apply configuration
  ansible.builtin.systemd:
    name: nix-daemon
    state: restarted
  when:
    - install_nix | default(false)
  ignore_errors: true
  tags: nix

- name: Verify Nix installation
  ansible.builtin.shell: |
    . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
    nix --version
  register: nix_version_output
  changed_when: false
  when:
    - install_nix | default(false)
    - nix_installed.stat.exists or (nix_installed is defined and not nix_installed.stat.exists)
  ignore_errors: true
  tags: nix

- name: Display Nix version
  ansible.builtin.debug:
    msg: "Nix package manager installed: {{ nix_version_output.stdout }}"
  when:
    - install_nix | default(false)
    - nix_version_output is defined
    - nix_version_output.stdout is defined
  tags: nix

# ============================================================================
# GitHub CLI Installation
# ============================================================================

- name: Check if GitHub CLI is installed
  ansible.builtin.command: gh --version
  register: gh_installed
  ignore_errors: true
  changed_when: false
  when: install_gh_cli | default(false)
  tags: gh

- name: Install GitHub CLI
  when:
    - install_gh_cli | default(false)
    - gh_installed is failed
  tags: gh
  block:
    - name: Install prerequisites for GitHub CLI
      ansible.builtin.apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
        state: present

    - name: Create keyrings directory
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'

    - name: Add GitHub CLI GPG key
      ansible.builtin.shell: |
        curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | \
        gpg --dearmor -o /etc/apt/keyrings/githubcli-archive-keyring.gpg
      args:
        creates: /etc/apt/keyrings/githubcli-archive-keyring.gpg

    - name: Set permissions on GitHub CLI GPG key
      ansible.builtin.file:
        path: /etc/apt/keyrings/githubcli-archive-keyring.gpg
        mode: '0644'

    - name: Add GitHub CLI repository
      ansible.builtin.apt_repository:
        repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main"
        filename: github-cli
        state: present

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true

    - name: Install GitHub CLI
      ansible.builtin.apt:
        name: gh
        state: present
        force_apt_get: true
      environment:
        DEBIAN_FRONTEND: noninteractive

- name: Verify GitHub CLI installation
  ansible.builtin.command: gh --version
  register: gh_version_output
  changed_when: false
  when: install_gh_cli | default(false)
  tags: gh

- name: Display GitHub CLI version
  ansible.builtin.debug:
    msg: "GitHub CLI installed: {{ gh_version_output.stdout_lines[0] }}"
  when:
    - install_gh_cli | default(false)
    - gh_version_output is defined
    - gh_version_output.stdout_lines is defined
  tags: gh
